

\section{Aproximate Dynamic Programming Model}
\subsection{Expectation ADP Model}
Let's convert it into ADP. We do that by changing $v(\vec{S})$ to an approximation as follows:
\begin{equation}\begin{alignedat}{10}
		& v(\vec{ul}, \vec{pw}, \vec{ps}) 
		&& =  \beta^0 + \sum_{p} \beta_{p}^{ul} ul_{p} +
		\sum_{mdc} \beta_{mdc}^{pw} pw_{mdc}  + 
		\sum_{tmdc} \beta_{tmdc}^{ps} ps_{tmdc}
\end{alignedat} \end{equation}

Next we need to convert a part of equation \ref{full-adp-equation} into expectation. \\ 
(To make it easier later, we will format is as $v(\vec{S}) - E[v(\vec{S}')]$)

\begin{itemize}
	\item $E[ued_p] = 0$
	\item $E[pwt_{mdc}] = ptp_{dc} * \hat{pw}_{mdc}$ 
	\item $E[pst_{tmdc}] = ptp_{dc} * \hat{ps}_{tmdc}$ 
\end{itemize}

\begin{fleqn}[\parindent]
	\begin{equation}
		\beta^{0}: \qquad (1-\gamma) \beta^{0}
	\end{equation}
\end{fleqn}

\begin{fleqn}[\parindent]
	\begin{equation}
		\beta^{ul}_{p}: \qquad 
		\sum_{p \in \text{co}} \beta_{p}^{ul} \Big( ul_{p} - \gamma ( \hat{ul}_{p}) \Big) + 
		\sum_{p \in \text{nco}} \beta_{p}^{ul} ( ul_{p}) 
	\end{equation}
\end{fleqn}

\begin{fleqn}[\parindent]
	\begin{equation}\begin{alignedat}{10}
			& \beta^{pw}_{mdc}: \qquad 
			&& 	\sum_{dc} \beta_{0dc}^{pw} \Big( pw_{0dc} - \gamma (pea_{dc}) \Big) +
			\sum_{m=1dc}^{TL_{dc}-1} \beta_{mdc}^{pw} 
			\Big( pw_{mdc} - \gamma 
			(\hat{pw}_{m-1dc}) \Big) + \\
			& && \sum_{m=TL_{dc}dc}^{M-1} \beta_{mdc}^{pw} 
			\Big( pw_{mdc} - \gamma 
			(\hat{pw}_{m-1dc} + E[pwt_{m-1d-1c}] - E[pwt_{m-1dc}]) \Big) + \\
			& && \sum_{dc} \beta_{Mdc}^{pw} 
			\Big( pw_{Mdc} - \gamma \sum_{M-1}^{M}
			(\hat{pw}_{mdc} + E[pwt_{md-1c}] - E[pwt_{mdc}]) \Big)
	\end{alignedat} \end{equation}
\end{fleqn}

\begin{fleqn}[\parindent]
	\begin{equation}\begin{alignedat}{10}
			& \beta^{ps}_{tmdc}: \qquad 
			&& \sum_{tdc} \beta_{t0dc}^{ps} \Big( ps_{t0dc}) \Big) + 
			\sum_{mdc} \beta_{Tmdc}^{ps} \Big( ps_{Tmdc}) \Big) + 
			\sum_{t=1m=1dc}^{T-1, TL_{dc}-1} \beta_{tmdc}^{ps} 
			\Big( ps_{tmdc} - \gamma 
			(\hat{ps}_{t+1m-1dc}) \Big) + \\
			&	&& 
			\sum_{t=1m=TL_{dc}dc}^{T-1,M-1} \beta_{tmdc}^{ps} 
			\Big( ps_{tmdc} - \gamma 
			(\hat{ps}_{t+1m-1dc} + E[pst_{t+1m-1d-1c}] - E[pst_{t+1m-1dc}]) \Big) + \\
			&	&& \sum_{t=1dc}^{T-1} \beta_{tMdc}^{ps} 
			\Big( ps_{tMdc} - \gamma \sum_{M-1}^{M}
			(\hat{ps}_{t+1mdc} + E[pst_{t+1md-1c}] - E[pst_{t+1mdc}]) \Big)
	\end{alignedat} \end{equation}
\end{fleqn}

Using the numbers above we rearrange the original equation as follows:
\begin{equation}
	\max_{\vec{\beta}} \Big( \sum \beta^{0} + \sum \beta^{ut} E[ut] + \sum \beta^{pw} E[pw] + \sum \beta^{ps} E[ps] \Big)
\end{equation}
Subject to:
\begin{equation}
	v(\vec{S}) - E[v(\vec{S}')] \le c(\vec{S}, \vec{A}) \quad \forall \vec{S} \vec{A} 
\end{equation}


\subsection{ADP Master Problem}
\label{Dual of ADP LP}
Converting to Dual
\begin{equation}
	\min_{w} \sum_{\vec{S} \vec{A}} w(\vec{S} \vec{A}) c(\vec{S} \vec{A})
\end{equation}
Subject To:

\begin{alignat}{10}
	& \beta^{0}: 
	&&	\sum_{\vec{S}\vec{A}}\vec{w} (1 - \gamma) = 1 \\
	& \beta^{ul}: 
	&& 	\sum_{\vec{S}\vec{A}}\vec{w} \Big(ul_{p} - 
	\gamma (\hat{ul}_{p}) \Big) \ge E[ul_{p}] 
	&&	\forall p \in \{ \text{carry over} \} \\ 
	&	&& 	\sum_{\vec{S}\vec{A}}\vec{w} ( ul_{p}) \ge E[ul_{p}]
	&&	\forall p \in \{ \text{non carry over} \}\\
	&	\beta^{pw}: 
	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(pw_{0dc} - 
	\gamma (pea_{dc}) \Big) \ge E[ps_{0dc}]
	&&	\forall dc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(pw_{mdc} - 
	\gamma (\hat{pw}_{m-1dc}) \Big) \ge E[pw_{mdc}]
	&&	\forall m \in \{1...TL_{dc}-1\} dc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(pw_{mdc} - 
	\gamma (\hat{pw}_{m-1dc} + E[pwt_{m-1d-1c}] - E[pwt_{m-1dc}]) \Big) \ge E[pw_{mdc}]
	&&	\forall m \in \{TL_{dc}...M-1\} dc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(pw_{Mdc} - \gamma 
	\sum_{M-1}^{M} (\hat{pw}_{mdc} + E[pwt_{md-1c}] - E[pwt_{mdc}]) \Big) \ge E[pw_{Mdc}]
	&&	\forall dc \\ 
	&	\beta^{ps}: 
	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(ps_{t0dc} \Big) \ge E[ps_{t0dc}]
	&&	\forall tdc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(ps_{Tmdc} \Big) \ge E[ps_{Tmdc}]
	&&	\forall mdc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(ps_{tmdc} - \gamma 
	(\hat{ps}_{t+1m-1dc}) \Big) \ge E[ps_{tmdc}] \;
	&&	\forall \{1...T-1\} \{1...TL_{dc}-1\}dc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(ps_{tmdc} - \gamma 
	(\hat{ps}_{t+1m-1dc} + E[pst_{t+1m-1d-1c}] - E[pst_{d}]) \Big) \ge E[ps_{tmdc}] \;
	&&	\forall \{1...T-1\} \{TL_{dc}...M-1\}dc \\
	&	&&	\sum_{\vec{S}\vec{A}}\vec{w} \Big(ps_{tMdc} - \gamma \sum_{M-1}^{M}
	(\hat{ps}_{t+1mdc} + E[pst_{t+1md-1c}] - E[pst_{d}]) \Big) \ge E[ps_{tMdc}] \;
	&&	\forall \{1...T-1\} dc
\end{alignat}

\begin{equation}
	\text{State Action Bounds:} \qquad w \ge 0 \qquad \forall w
\end{equation}


\subsection{ADP Pricing Problem}
\label{Pricing Problem}
\begin{equation}
	\min_{(\vec{ue}, \vec{uu}, \vec{pw}, \vec{pe}, \vec{ps}) \in S,  (\vec{sc}, \vec{rsc}) \in A } c(\vec{pw},\vec{sc},\vec{rsc},\vec{uv}) - \Big(v(\vec{S}) - E[v(\vec{S}')] \Big)
\end{equation}
Subject to:
constraints in sections "\nameref{state-action constraints}" and "\nameref{auxiliary constraints}"

\section{Solution Explanation}
\subsection{Algorithm for solving}
To get $\vec{\beta}$ values, which will be used to generate an action follow steps below:
\begin{enumerate}
	\item Perform a monte-carlo simulation (following some arbitrary policy) to get $E[ue], E[uu], E[pw] E[pw]$
	\item Create an initial feasible set of state-action pairs - $\vec{w}$
	\item Solve model in section "\nameref{Dual of ADP LP}" where each state-action pairs in $\vec{w}$ corresponds to a variable and parameters for all the constraints for a specific action.
	\item Solve model in section "\nameref{Pricing Problem}", where duals from problem in step 3  correspond to $\vec{\beta}$ values. 
	\begin{itemize}
		\item If objective function is less than 0, add solution as a single state-action pair to $\vec{w}$ and go to step 3
		\item If objective function is greater than 0, continue to next step
	\end{itemize}
	\item Duals from problem in step 3 correspond to final $\vec{\beta}$ values
\end{enumerate}

\subsection{Generating an Action}
Once $\vec{\beta}$ values have been approximated, you may use the model below to generate a recommended action for a specific state.
\begin{equation*}
	\min_{\vec{A}} c(\vec{S}, \vec{A}) + \gamma v(S')
\end{equation*}	

\begin{equation}\begin{alignedat}{10}
		&	v(S') = \Bigg( 
		&& 	\beta^0 + 
		\bigg( \sum_{p} \beta_{1p}^{ue} 
		(uen_{d} + ue_{1p} - \hat{uu}_{1p} + uv_{1p}) \bigg)+
		\bigg( \sum_{t=2,p}^{T} \beta_{tp}^{ue} uen_{d} \bigg)+ \\
		&	&& 	\bigg( \sum_{tp}^{T-1} \beta_{tp}^{uu} 
		( \hat{uu}_{t+1,p} + \sum_{mdc} E[pst_{tmdc}] (U_{pd+1c} - U_{pdc})) \bigg) + \\
		&	&&	\bigg( \sum_{dc} \beta_{0dc}^{pw} pea_{dc} \bigg) +
		\bigg( \sum_{m=1,dc}^{M-1} \beta_{mdc}^{pw} 
		(\hat{pw}_{m-1dc} + E[pwt_{m-1d-1c}] - E[pwt_{m-1dc}]) \bigg) + \\
		&	&&	\qquad \qquad \bigg( \sum_{dc} \beta_{Mdc}^{pw} 
		(\sum_{M-1}^{M} \hat{pw}_{mdc} + E[pwt_{md-1c}] - E[pwt_{mdc}])\bigg) + \\
		& 	&&	\bigg( \sum_{t=1m=1dc}^{T-1M-1} \beta_{tmdc}^{ps} 
		(\hat{ps}_{t+1m-1dc} + E[pst_{t+1m-1d-1c}] - E[pst_{t+1m-1dc}]) \bigg) + \\	
		&	&&	\qquad \qquad \bigg( \sum_{t=1Mdc}^{T-1} \beta_{tmdc}^{ps} 
		(\sum_{M-1}^{M} (\hat{ps}_{t+1mdc} + E[pst_{t+1md-1c}] - E[pst_{t+1mdc}])) \bigg)
		\Bigg)
	\end{alignedat}
\end{equation}

Subject to:
constraints in section "\nameref{state-action constraints}"

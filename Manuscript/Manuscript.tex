\documentclass{article}

\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{xcolor}

\usepackage{hyperref}
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}

\geometry{margin=1in}
\setlength\parindent{0pt}


\title{Dynamic Knapsack Problem}
\author{KV}
\date{February 2021}

\begin{document}

\maketitle
\tableofcontents

\section{Questions/Comments}

\subsection{Questions}
\begin{itemize}
	\item  NEED TO MOVE $uv$ TO STATES AND ADJUST ALL THE RELEVANT EQUATIONS FOR IT
	\item Need to change subproblem formulation
	\item Potentially add a new action - to remove patients, with very high cost - in order to have an easily feasible state-action
\end{itemize}

\subsection{Comments}
\begin{itemize}
	\item
\end{itemize}

\section{Assumptions} 
\begin{itemize}
	\item Assume all new patients are arriving at the beginning of the period 
	\begin{itemize}
		\item Assume arrivals follow poisson distribution
	\end{itemize}		
	
	\item It is assumed that there is no difference between how long a patient waits for their appointment within some limit ($Tl$). 
	\begin{itemize}
		\item Let's assume our limit is 10 periods, there is no difference in terms of cost between patients who has been waiting for 1 period and patients waiting 9 period for their appointment (assuming they are the same category).  
		\item However, if a patient waits for 11 period for their appointment there should be some kind of penalty for the wait
		\item The penalty comes from increasing patient complexity. Higher complexities require more resources and are thus more costly overall in the system
	\end{itemize}		
	
	\item We assume patient complexity transitions follow binary distribution - each period a patient can become more complex with a certain probability
		\begin{itemize}
			\item While patient is waiting less that $Tl$, the transition probability is 0.
			\item After $Tl$, transition probability is some arbitrary value
		\end{itemize}
	
	\item It is assumed if a patient is scheduled in period one, it means they are served "immediately", regardless if in practice the appointment is at the beginning or end of the period.
	\item We distinguish between two types of reschedules: good and bad reschedules
	\begin{itemize}
		\item Good reschedules are reschedules where a patient is rescheduled to an earlier period
		\item Bad reschedules are reschedules where a patient is rescheduled to a later period
	\end{itemize}

	\item We assume that only specific reschedules are allowed (to simplify the model, and remove  redundancies)
		\begin{itemize}
			\item Good reschedules are allowed from any period after 2 into period 1
			\item Bad reschedules are only allowed from period 1 to period 2
		\end{itemize}
	
	\item It is assumed that there is a certain default expected number of PPE units available for all periods
		\begin{itemize}
			\item However, in the period 1, there is some random deviation from the expected number of units
			\item This random deviation follows some uniform distribution
		\end{itemize}
\end{itemize}

\section{MDP Model}
\subsection{Decision Epochs}
Decisions are made at the beginning of each time period (will be weeks)

\subsection{State Space}
State space is defined by current units available for various PPEs for future periods, amount of units already used for various PPEs, current patient waitlist, expected period demand, and number of patients already scheduled
\[  \vec{S}  = (\vec{ue}, \vec{uu}, \vec{uv}, \vec{pw}, \vec{pe}, \vec{ps}) \]
\begin{itemize}
    \item $\vec{ue} = ue_{tp}$ - Expected unist for period $t$, and PPE $p$
    \item $\vec{uu} = uu_{tp}$ - Used units for period $t$, and PPE $p$
    \item $\vec{uv} = uv_{tp}$ - goal variable, violation on number of resources used for period $t$, of PPE $p$
    \item $\vec{pw} = pw_{mdc}$ - Number of patients of complexity $d$, CPU $c$, on a wait list for $m$ periods
    \item $\vec{pe} = pe_{dc}$ - Number of patients of complexity $d$, CPU $c$ expected to arrive this period
    \item $\vec{ps} = ps_{tmdc}$ - Number of patients of complexity $d$, CPU $c$, scheduled to period $t$, who have been on the waitlist for $m$ periods ($m$ of 0 stands for people who have just arrived)
\end{itemize}

\subsection{Action Sets}

\subsubsection{Description}
At the beginning of each period, decision maker must reschedule appointments as necessary (if patient complexity increased and too much PPE is being used, or if expected units of PPE have changed negatively). And decision maker must also schedule patients to surgeries
\[  \vec{A} = (\vec{sc}, \vec{rsc}, \vec{uv}) \] 
\begin{itemize}
    \item $\vec{sc} = sc_{tmdc}$ - Number of patients of difficulty $d$, CPU $c$, who have been in wait list for $m$ periods, to schedule in period $t$ ($m$ of 0 stands for people who have just arrived)
	\item $\vec{rsc} = rsc_{tt'mdc}$ - Number of patients of difficulty $d$, CPU $c$, who have been on the waitlist for $m$ periods, to reschedule from period $t$ to period $t'$
	\item $uv_{tp}$ - goal variable, violation on number of resources used for period $t$, of PPE $p$
\end{itemize}

\subsubsection{Action Constraints}
\label{action constraints}
\begin{itemize}
    \item Total number of PPE units cannot be exceeded  
    \begin{itemize}
    		\item ($U_{pdc}$ - usage of PPE $p$ per patient difficulty $d$, CPU $c$)
    \end{itemize}
        \begin{equation} 
			\sum_{mdc}(sc_{tmdc})U_{pdc} <= (ue_{tp} - uu_{tp}) + uv_{tp}\ \quad \forall tp
		\end{equation}
	
	\item Bounds on when reschedules are allowed
		\begin{equation}  
			rsc_{tt'mdc} = 0 \quad \forall t \in \{ 2...T \}, t' \in \{2...T\} mdc 
		\end{equation} 
		\begin{equation}  
			rsc_{tt'mdc} = 0 \quad \forall t \in \{ 1 \}, t'\in \{ 3...T \} mdc 
		\end{equation} 
		\begin{equation}  
			rsc_{tt'mdc} = 0 \quad \forall tt'mdc, \text{where } t=t' 
		\end{equation} 

	\item Cap on max schedule/reschedule wait time
		\begin{equation}  
			\sum_{tmdc} sc_{tmdc} = 0 \quad \text{where } t+m-1 > 2Tl 
		\end{equation} 
		\begin{equation}  
			\sum_{tt'mdc} rsc_{tt'mdc} \quad \text{where } t'+m+1 > 2Tl 
		\end{equation} 

	\item number of people scheduled/rescheduled must be consistent
		\begin{equation}  
			\sum_{t'} rsc_{tt'mdc} \le ps_{tmdc} \quad \forall tmdc 
		\end{equation} 
		\begin{equation}  
			\sum_{t} sc_{t0dc} \le pe_{dc} \quad \forall dc 
		\end{equation} 
		\begin{equation}  
			\sum_{t} sc_{tmdc} \le pw_{mdc} \quad \forall m \in \{1...M \}, dc 
		\end{equation} 
\end{itemize}

\subsection{Transition Probabilities}

\subsubsection{Uncertainty Sources}
\begin{enumerate}
    	
	\item Number of patients arriving this period - $pe_{dc}$
		\begin{itemize}
			\item let's assume $pea_{dc}$ - is the random variable that represents the number of patients arrived this period. It follows a poisson distribution.
		\end{itemize}
	
	\item Transition between patient difficulties within the wait list - $pw_{mdc}$
		\begin{itemize}
			\item let's assume $pwt_{mdc}$ is the random variable that represents the number of patients of priority $d$, CPU $c$, that have been waiting for $m$ period, that have moved a more complex category. It follows binary distribution.
		\end{itemize}
		
	\item Transition between patient difficulties within the scheduled list - $ps_{tmdc}$
		\begin{itemize}
			\item let's assume $pst_{tmdc}$ is the random variable that represents the number of patients of priority $d$, CPU $c$, that have been waiting for $m$ period, that have been scheduled into period $t$, that have moved a more complex category. It follows binary distribution.
		\end{itemize}

	\item Amout of expected units of PPE resource for the next time period - $ue_{1p}$
		\begin{itemize}
			\item let's assume $ued_{d}$ is the random variable that represents the deviation of PPE units from the expectation for the next period only. It follows some uniform distribution.
			\item let's assume $uen_{d}$ is the default value to be used for expected number of PPE units $p$ per period
		\end{itemize}
\end{enumerate}

\subsubsection{Transition Constraints}

\begin{enumerate}

	\item Transition from $\vec{ue}$ to $\vec{ue'}$ - Expected Units of PPE
		\begin{equation}  
			ue'_{1p} = ue_{2p} + ued_{p}\ \quad \forall p 
		\end{equation} 
		\begin{equation}  
			ue'_{t-1,p} = ue_{tp}\ \quad \forall t \in \{3...T\}, p
		 \end{equation} 
		\begin{equation}  
			ue'_{Tp} = uen_{p} \quad \forall p 
		\end{equation} 
	
	\item Transition from $\vec{uu}$ to $\vec{uu'}$ - Used Units of PPE		
		\begin{align} \begin{split}  
			uu'_{t-1,p} = &  uu	_{tp} + \sum_{mdc} ( sc_{tmdc} U_{pdc} ) - \\ 
								&	- \sum_{t'mdc} (rsc_{tt'mdc} U_{pdc}) + \sum_{tmdc} (rsc_{tt'mdc} U_{pdc}) + \\ 
								& 	+ \sum_{mdc} pst_{tmdc} (U_{pd+1c} - U_{pdc})  \quad \forall t \in \{2...T\}, p  
		\end{split} \end{align}
		\begin{equation}  
			uu'_{Tp} = 0 \quad \forall p 
		\end{equation} 
		
	\item Transition from $\vec{uv}$ to $\vec{uv'}$ - Violation of PPE units
	\begin{equation}
		uv'_{tp} \ge uu'_{tp} - ue'_{tp} \quad \forall tp
	\end{equation}
	\begin{equation}
		uv'_{tp} \ge 0 \quad \forall tp
	\end{equation}
	\begin{equation}
		uv'_{tp} = \max \{0, uu'_{tp} - ue'_{tp} \} \quad \forall tp
	\end{equation}

	\item Transition from $\vec{pe}$ to $\vec{pe'}$ - Expected number of patients for this month
		\begin{equation} 
			\ pe_{dc} = pea_{dc} \quad \forall dc 
		\end{equation} 

	\item Transition from $\vec{pw}$ to $\vec{pw'}$ - Flow of patients between difficulties/scheduling/cancelling for waitlist
		\begin{equation}  
			pw'_{1dc} = pe_{dc} - \sum_{t} sc_{t0dc} \quad \forall dc 
		\end{equation} 
		\begin{equation}  
			pw'_{m+1, dc} = pw_{mdc} - \sum_{t} sc_{tmdc} + pwt_{m,d-1,c} - pwt_{mdc} \quad \forall m \in \{1...M-2 \}, dc 
		\end{equation} 
		\begin{equation}  
			pw'_{Mdc} = \sum_{M-1}^M pw_{mdc} - \sum_{t,M-1}^{M} sc_{tmdc} + \sum_{M-1}^{M} pwt_{m,d-1,c} - 
			\sum_{M-1}^{M} pwt_{mdc}\quad \forall dc 
		\end{equation} 

	\item Transition from $\vec{ps}$ to $\vec{ps'}$ - Flow of patiensts between difficulties/scheduling/cancelling for scheduled appointments
		\begin{align}  \begin{split}
			ps'_{t-1,m+1,dc} = & ps_{tmdc} +  \sum_{t} sc_{tmdc} - \sum_{t'} rsc_{tt'mdc} + \sum_{t} rsc_{tt'mdc} +\\ 
										& + pst_{tm,d-1,c} - pst_{tmdc} \quad \forall t \in \{2 ... T\},  m \in \{0... M-2 \}, dc 
		\end{split} \end{align} 
		\begin{align} \begin{split}  
			ps'_{t-1,Mdc} = & \sum_{M-1}^M ps_{mdc}  - \sum_{t,M-1}^{M} sc_{tmdc}  - \sum_{t'M-1}^M rsc_{tt'mdc} + \\
									& \sum_{t,M-1}^M rsc_{tt'mdc} + \sum_{M-1}^{M} pst_{tm,d-1,c} - \sum_{M-1}^{M} pst_{tm,d,c}
									\quad \forall t \in \{2...T \}, dc 
		\end{split} \end{align}		
		\begin{equation}  
			ps'_{Tmdc} = 0 \quad \forall mdc 
		\end{equation} 
\end{enumerate}
    
\subsection{Costs}
Cost will come from two source:  
\begin{itemize} 
	\item cost of waiting ($cw$) (comes from 2 things)
	\item cost of canceling ($cc$)
	\item goal variable (to eliminate constraint violation, but still allow it if necessary)
\end{itemize}

\begin{align} \begin{split}  
	\vec{C} = c(\vec{pw}, \vec{sc}, \vec{rsc}, \vec{uv}) = & \sum_{mdc} cw_{m} (pw_{mdc} - \sum_{t} sc_{tmdc}) +  \\
		& + cc \sum_{tt`mdc, \text{where } t' > t} rsc_{tt'mdc} - cc \sum_{tt`mdc, \text{where } t' < t} rsc_{tt'mdc} + \\ 
		& + M (uv_{tp})
\end{split} \end{align} 
$cw_{m}$ is computed as follows ($val$ is arbitrary number that describes cost growth):
	\begin{equation}  cw_{m} = val^m \quad \forall m \end{equation} 
$cc$ is some arbitrary value

\section{LP Model}

\subsection{Full LP} 
Given a full MDP model, the equivalent LP would look as follows 
(Note: there is a lot left out. $\vec{C}$ is defined above, all states, actions, and next states are all defined above). Probability distribution is not explicitly defined, but I am not sure if it is necessary
\begin{equation}
	\max_{\vec{v}} \sum \alpha (\vec{S}) v(\vec{S}) 
\end{equation}

subject to
\begin{equation}
	c(\vec{pw}, \vec{sc}, \vec{rsc}, \vec{uv}) + \gamma \sum_{\vec{p}} p(\vec{pea}, \vec{pwt}, \vec{pst}, \vec{ued}) v( \vec{S'} | \vec{S}, \vec{A}, \vec{pea}, \vec{pwt}, \vec{pst}, \vec{ued}) \ge v(\vec{S}) \quad \forall \vec{S} \vec{A}
\end{equation}

\subsection{Full ADP LP }
Let's convert it into ADP. We do that by changing $v(\vec{S})$ to an approximation as follows:
\begin{align} \begin{split}
	v(\vec{ue}, \vec{uu}, \vec{pw}, \vec{pe}, \vec{ps}) =  & \beta^0 +
		\sum_{tp} \beta_{tp}^{ue} ue_{tp} +
		\sum_{tp} \beta_{tp}^{uu} uu_{tp} + \\
		& + \sum_{mdc} \beta_{mdc}^{pw} pw_{mdc}  + 
		\sum_{dc} \beta_{dc}^{pe} pe_{dc} + 
		\sum_{tmdc} \beta_{tmdc}^{ps} ps_{tmdc}
\end{split} \end{align}

This gives the following LP
\begin{equation}
	\max_{\vec{\beta}} \sum \alpha (\vec{ue}, \vec{uu}, \vec{pw}, \vec{pe}, \vec{ps}) v(\vec{ue}, \vec{uu}, \vec{pw}, \vec{pe}, \vec{ps})
\end{equation}
Subject to:
\begin{align*}
	& c(\vec{pw}, \vec{sc}, \vec{rsc}, \vec{uv}) + \gamma \sum_{\vec{p}} p(\vec{pea}, \vec{pwt}, \vec{pst}, \vec{ued})  *  \\
		& * \Bigg( \beta^{0} +
		\bigg( \sum_{p} \beta_{1p}^{ue} (ue_{2p} + ued_{p}) + 
				\sum_{t=2,p}^{T-1} \beta_{tp}^{ue} ue_{t+1,p} + 
				\sum_{p} \beta_{Tp}^{ue} uen_{d} \bigg) +
		\bigg( \sum_{p} \beta_{Tp}^{uu} * 0 \bigg) + \\
		& \bigg( \sum_{tp}^{T-1} \beta_{tp}^{uu} 
				\Big( uu_{t+1,p} + \sum_{mdc} (sc_{t+1,mdc}U_{pdc})  - 
				\sum_{t'mdc} (rsc_{t+1,t'mdc} U_{pdc}) + \sum_{tmdc} (rsc_{tt'+1,mdc} U_{pdc})  + \\ 
				& \quad \quad \quad \quad \quad \sum_{mdc} pst_{tmdc} (U_{pd+1c} - U_{pdc}) \Big) \bigg) +  \\
		& \bigg( \sum_{dc} \beta_{dc}^{pe} pea_{dc} \bigg) + 
			\bigg( \sum_{dc} \beta_{1dc}^{pw} (pe_{dc} - \sum_{t} sc_{t0dc}) \bigg) + \\
		&  \bigg( \sum_{m=2,dc}^{M-1} \beta_{mdc}^{pw} 
			(pw_{m-1,dc} - \sum_{t} sc_{t,m-1,dc} + pwt_{m-1,d-1,c} - pwt_{m-1,dc}) \bigg) + \\
		& \bigg( \sum_{dc} \beta_{Mdc}^{pw} 
			(\sum_{M-1}^{M} pw_{mdc} - \sum_{M-1,t}^{M} sc_{tmdc} + 
			\sum_{M-1}^{M} pwt_{m,d-1,c} - \sum_{M-1}^{M} pwt_{mdc}) \bigg) + \\
		& \bigg( \sum_{mdc} \beta_{Tmdc}^{ps} * 0  \bigg) + \\
		& \bigg( \sum_{t=1,m=1,dc}^{T-1,M-1} \beta_{tmdc}^{ps} 
			\Big( ps_{t+1m-1dc} - \sum_{t} sc_{t+1,m-1,dc} + 
			pst_{t+1,m-1,d-1,c} - pst_{t+1,m-1,dc} - \\
		& \quad \quad \quad \quad \quad \quad  \quad \quad- \sum_{t'} rsc_{t+1,t'm-1,dc} +  \sum_{t} rsc_{t,t'+1,m-1,dc} \Big) \bigg) + \\
		& \bigg( \sum_{t=1dc}^{T-1} \beta_{tMdc}^{ps} 
			\Big( \sum_{M-1}^{M} ps_{t+1,mdc} - \sum_{M-1,t}^{M} sc_{t+1,mdc} + 
			\sum_{M-1}^{M} pst_{t+1,m,d-1,c} - \sum_{M-1}^{M} pst_{t+1,mdc} - \\ 
			& \quad \quad \quad \quad \quad \quad \quad - \sum_{M-1,t'}^{M} rsc_{t+1,t'mdc} +  \sum_{M-1,t}^{M} rsc_{t,t'+1,mdc} \Big) \bigg) \\
		& \Bigg) \ge v(\vec{ue}, \vec{uu}, \vec{pw}, \vec{pe}, \vec{ps}) \quad \forall \vec{S} \vec{A}
\end{align*}
\begin{equation*}
	\vec{\beta} \ge 0 \quad \forall \beta
\end{equation*}


\subsection{Expectation ADP LP}
Steps for converting the mega constraint $v(\vec{S'})$ into expectation and merging it with $v({\vec{S}})$:
\begin{itemize}
	\item $\beta^{0}$ - no adjustments for expectation for $v(\vec{S'})$ 
	\begin{equation*}
		\beta^{0} - \gamma \beta^{0} = \color{red} (1-\gamma) \beta^{0}
	\end{equation*}
	
	\item $\beta_{tp}^{ue}$
	\begin{equation*}
		E[ued_{p}] = 0 \quad \therefore \quad
		\sum_{p} \beta_{1p}^{ue} (ue_{2p} + ued_{p}) \rightarrow 
		\sum_{p} \beta_{1p}^{ue} (ue_{2p}) \rightarrow
		\sum \beta_{tp}^{ue} uen_{p}
	\end{equation*}
	\begin{equation*}
		\sum_{tp} \beta_{tp}^{ue} ue_{tp} - \gamma (\sum_{tp} \beta_{tp}^{ue} uen_{p}) = 
		\color{red} \sum_{tp} \beta_{tp}^{ue} (ue_{tp} - \gamma (uen_{p}))
	\end{equation*}
		
	\item $\beta_{tp}^{uu}$ - no adjustments for expectation
	\begin{equation*}
		uu_{Tp} = 0 \quad \therefore \quad \beta_{Tp}^{uu} uu_{Tp} = 0
	\end{equation*}
	\begin{align*}
		\sum_{tp}^{T-1} \beta_{tp}^{uu} uu_{tp} - \gamma \sum_{tp}^{T-1} \beta_{tp}^{uu} \bigg( 
					& uu_{t+1p} + \sum_{mdc} (sc_{t+1mdc}U)  - \sum_{tmdc} (rsc_{t+1t'mdc} U) + \sum_{t'mdc} (rsc_{tt'+1mdc} U) + \\ 
					&\sum_{mdc} ps_{tmdc}pwp_{mdc} (U_{pd+1c} - U_{pdc}) \bigg)
	\end{align*}
	{ \color{red} \begin{align*}
		 \Bigg( \sum_{tp}^{T-1} \beta_{tp}^{uu} \bigg( & 
		 	uu_{tp}	 - \gamma \Big( uu_{t+1p} + \sum_{mdc} ps_{tmdc}pwp_{mdc} (U_{pd+1c} - U_{pdc}) + \\
			& U_{pdc} \big( \sum_{mdc} sc_{t+1mdc}  - \sum_{t'mdc} rsc_{t+1t'mdc} + \sum_{tmdc} rsc_{tt'+1mdc} \big) \Big) \bigg) + \\
		\beta_{Tp}^{uu} (uu_{Tp}) \Bigg)
	\end{align*} }
	
	\item $\beta_{dc}^{pe}$
	\begin{equation*}
		\sum_{dc} \beta_{dc}^{pe} pe_{dc} - \gamma \sum_{dc} \beta_{dc}^{pe} E[pea_{dc}] = 
		\color{red} \sum_{dc} \beta_{dc}^{pe} (pe_{dc} - \gamma E[pea_{dc}])
	\end{equation*}	
	
	\item $\beta_{mdc}^{pw}$ - Let's assume $pwp_{mdc}$ - is the probability of a patient transitioning to a higher complexity
	\begin{equation*}
		E[pwt_{mdc}] = pw_{mdc} pwp_{mdc}		
	\end{equation*}
	{ \color{red} \begin{align*}
		\Bigg( \sum _{dc} \beta_{1dc}^{pw}& ( pw_{1dc} - \gamma (pe_{dc} - \sum_{t} sc_{t0dc})) + \\
		\sum_{m=2,dc}^{M-1} \beta_{mdc}^{pw} & ( pw_{mdc} - \gamma 
			\big( pw_{m-1dc} (1 - pwp) + pw_{m-1d-1c} pwp - \sum_{t} sc_{tm-1dc} \big) + \\
		\sum_{dc} \beta_{Mdc}^{pw} & ( pw_{Mdc} - \gamma \sum_{M-1}^{M}
			\big( pw_{mdc} (1 - pwp) + pw_{md-1c} pwp - \sum_{t} sc_{tmdc} \big) \Bigg)
	\end{align*} }

	\item $\beta_{mdc}^{ps}$
	\begin{equation*}
		E[pst_{tmdc}] = ps_{tmdc} pwp_{mdc}		
	\end{equation*}
	{ \color{red} \begin{align*}
		\Bigg( \sum _{t=1 m=1 dc}^{T-1 M-1} \beta_{tmdc}^{ps} & 
			\bigg( ps_{tmdc} - 
				\gamma \Big( ps_{t+1m-1dc}(1-pwp) + ps_{t+1m-1d-1c} pwp - \sum_{t} sc_{t+1m-1dc} \\ 
				&  - \sum_{t'} rsc_{t+1t'm-1dc} + \sum_{t} rsc_{tt'+1m-1dc} \Big) \bigg) + \\
		\sum _{t=1dc}^{T-1} \beta_{tMdc}^{ps} & 
			\bigg( ps_{tMdc} - 
				\gamma \sum_{M-1}^{M} \Big( ps_{t+1mdc}(1-pwp) + ps_{t+1md-1c} pwp - \sum_{t} sc_{t+1mdc} \\ 
				&  - \sum_{t'} rsc_{t+1t'mdc} + \sum_{t} rsc_{tt'+1mdc} \Big) \bigg) + \\ 
		\sum_{mdc} \beta_{Tmdc}^{ps} & 
			\bigg( ps_{Tmdc} \bigg) \Bigg)
	\end{align*} }
	
\end{itemize}

Let's say $E[V]$ is the addition of all the red parts above. In that case the ADP model converted to expectation would look as follows:
\begin{equation}
	\max_{\vec{\beta}} \sum \beta^{0} + \sum \beta^{ue} E[ue] + \sum \beta^{uu} E[uu] + 
		\sum \beta^{pe} E[pe] + \sum \beta^{pw} E[pw] + \sum \beta^{ps} E[ps]
\end{equation}
Subject to:
\begin{equation}
	E[V] \le c(\vec{pw}, \vec{sc}, \vec{rsc}, \vec{uv}) \quad \forall \vec{S} \vec{A} 
\end{equation}


\subsection{Dual of ADP LP}
\label{Dual of ADP LP}
Converting to Dual
\begin{equation}
	\min_{w} \sum_{\vec{S} \vec{A}} w(\vec{S} \vec{A}) c(\vec{S} \vec{A})
\end{equation}
Subject To:
\begin{itemize}
	\item $\beta^{0}$ constraints
	\begin{equation}
		\sum_{\vec{S}\vec{A}}\vec{w} (1 - \gamma) = 1 
	\end{equation}
	
	\item $\beta^{ue}$ constraints	
	\begin{equation}
		\sum_{\vec{S}\vec{A}}\vec{w} \Big(ue_{tp} - \gamma (uen_{tp}) \Big) \ge E[ue_{tp}] \quad \forall tp
	\end{equation}	
	
	\item $\beta^{uu}$ constraints
	\begin{multline}
		\sum_{\vec{S}\vec{A}} \vec{w} \bigg( 
			uu_{tp}	 - \gamma \Big( uu_{t+1p} + \sum_{mdc} ps_{tmdc}pwp (U_{pd+1c} - U_{pdc}) + \\ 
			U_{pdc} \big( \sum_{mdc} sc_{t+1mdc}  - \sum_{t'mdc} rsc_{t+1t'mdc} + \sum_{tmdc} rsc_{tt'+1mdc} \big) \Big)
		\bigg) \ge E[uu_{tp}] \\
		\quad \forall T \in \{1...T-1\}p
	\end{multline}
	\begin{equation}
		\sum_{\vec{S}\vec{A}} \vec{w} (uu_{Tp}) \ge E[uu_{Tp}] \quad \forall p
	\end{equation}
	
	\item $\beta^{pe}$ constraints
	\begin{equation}
		\sum_{\vec{S}\vec{A}} \vec{w} (pe_{dc} - \gamma E[pea_{dc}])  \ge E[pe_{dc}] \quad \forall dc
	\end{equation}
	
	\item $\beta^{pw}$ constraints
	\begin{equation}
		  \sum_{\vec{S}\vec{A}}w  ( pw_{1dc} - \gamma (pe_{dc} - \sum_{t} sc_{t0dc})) \ge E[pw_{1dc}] \quad \forall dc
	\end{equation}
	\begin{multline}
		\sum_{\vec{S}\vec{A}}w  \Big( pw_{mdc} - \gamma \big( pw_{m-1dc} (1 - pwp) + pw_{m-1d-1c} pwp - \sum_{t} sc_{tm-1dc} \big) \Big) \\ 
		\ge E[pw_{mdc}]  \quad \forall m \in \{2 ... M-1 \}dc
	\end{multline}
	\begin{equation}
		\sum_{\vec{S}\vec{A}}w  \Big( pw_{Mdc} - \gamma \sum_{M-1}^{M}
			\big( pw_{mdc} (1 - pwp) + pw_{md-1c} pwp - \sum_{t} sc_{tmdc} \big) \Big) \ge E[pw_{Mdc}] \quad \forall dc
	\end{equation}
	
	\item $\beta^{ps}$ constraints
	\begin{multline}
		\sum_{\vec{S}\vec{A}}w \bigg( ps_{tmdc} - 
				\gamma \Big( ps_{t+1m-1dc}(1-pwp) + ps_{t+1m-1d-1c} pwp - \sum_{t} sc_{t+1m-1dc} \\ 
				 - \sum_{t'} rsc_{t+1t'm-1dc} + \sum_{t} rsc_{tt'+1m-1dc} \Big) \bigg) \\ 
				 \ge E[ps_{tmdc}] \quad \forall t \in \{t...T-1 \} m \in \{1 ... M-1 \} dc
	\end{multline}
	\begin{multline}
		\sum_{\vec{S}\vec{A}}w \bigg( ps_{tMdc} - 
				\gamma \sum_{M-1}^{M} \Big( ps_{t+1mdc}(1-pwp) + ps_{t+1md-1c} pwp - \sum_{t} sc_{t+1mdc} \\ 
				 - \sum_{t'} rsc_{t+1t'mdc} + \sum_{t} rsc_{tt'+1mdc} \Big) \bigg) \\ 
				 \ge E[ps_{tmdc}] \quad \forall t \in \{t...T-1 \} dc
	\end{multline}
	\begin{equation}
		\sum_{\vec{S}\vec{A}} \vec{w} (ps_{Tmdc}) \ge E[ps_{Tmdc}] \quad \forall mdc
	\end{equation}
	
	\item State-Action constraints
	\begin{equation}
		w \ge 0 \quad \forall w
	\end{equation}
\end{itemize}

\subsection{Finding most violated constraints of ADP LP}
\label{Pricing Problem}
\begin{equation}
	\min_{(\vec{ue}, \vec{uu}, \vec{pw}, \vec{pe}, \vec{ps}) \in S,  (\vec{sc}, \vec{rsc}) \in A } c(\vec{pw},\vec{sc},\vec{rsc},\vec{uv}) - E[V]
\end{equation}
Subject to:
all constraints in section "\nameref{action constraints}"

\subsection{Algorithm for solving}
To get $\vec{\beta}$ values, which will be used to generate an action follow steps below:
\begin{enumerate}
	\item Perform a monte-carlo simulation (following some arbitrary policy) to get $E[ue], E[uu], E[pe], E[pw] E[pw]$ (this will only give an approximation as arbitrary policy will likely be different from ADP policy) (if you wanted to, you could resolve for $\vec{\beta}$ again, but replacing $E[ue], E[uu], E[pe], ...$ with the ones that would be generated through the ADP policy) 
	\item Create an initial feasible set of state-action pairs - $\vec{w}$
	\item Solve model in section "\nameref{Dual of ADP LP}" where each state-action pairs in $\vec{w}$ corresponds to a variable and parameters for all the constraints
	\item Solve model in section "\nameref{Pricing Problem}", where duals from problem in step 3  correspond to $\vec{\beta}$ values. 
		\begin{itemize}
			\item If objective function is less than 0, add solution as a single state-action pair to $\vec{w}$ and go to step 3
			\item If objective function is greater than 0, continue to next step
		\end{itemize}
	\item Duals from problem in step 3 correspond to final $\vec{\beta}$ values
\end{enumerate}
	
\subsection{Generating an Action}
Once $\vec{\beta}$ values have been approximated, you may use the model below to generate a recommended action for a specific state.
\begin{equation}
	\min_{\vec{A}} c(\vec{S}, \vec{A}) + E[V]
\end{equation}
Subject to:
all constraints in section "\nameref{action constraints}"


\end{document}

---
title: "Dynamic Knapsack Model Report"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
    toc_depth: 3
    lightbox: TRUE
    gallery: TRUE
---

```{r setup, include=FALSE, cache=FALSE}
## Global options
library(reticulate)
library(knitr)

library(scales)
library(here)
library(tidyverse)
library(readr)
library(plotly)
library(tidyverse)

knitr::opts_chunk$set(cache = TRUE)
reticulate::use_condaenv('uOttawa-dyn-knap-R', required=TRUE)
source_python("z_factor.py")
source(here('Report_Stuff/data_funcs.R'))

### Generate Data
warm <- 250
dur <- 1250
repl <- 30

# path <- "R1R2"
# R1R2 <- generate_summary(path, dur, warm, repl)
R1R2_beta_file <- "Data/sens-data/smaller-full/betas/cw1-cc5-cv10-gam99-smaller-full-nopri-optimal-R1R2.pkl"
return_data(R1R2_beta_file, FALSE, FALSE)
return_data(R1R2_beta_file, FALSE, TRUE)

# path <- "R1R2R3"
# R1R2R3 <- generate_summary(path, dur, warm, repl)
R1R2R3_beta_file <- "Data/sens-data/smaller-full/betas/cw1-cc5-cv10-gam99-smaller-full-nopri-optimal-R1R2R3.pkl"
return_data(R1R2R3_beta_file, TRUE, FALSE)
return_data(R1R2R3_beta_file, TRUE, TRUE)

arrival_rate <- data.frame(
  Surgery = c('Surgery 1', 'Surgery 1', 'Surgery 4', 'Surgery 4', 'Surgery 6', 'Surgery 6'),
  Complexity = c('Complexity 1', 'Complexity 2', 'Complexity 1', 'Complexity 2', 'Complexity 1', 'Complexity 2'),
  "Arrival_Adjusted" = c(1.231988473, 0.615994236, 0.143731988, 0.102665706, 1.231988473, 0.615994236),
  "Arrival_Original" = c(1, 0.5, 0.0833, 0.0625, 1, 0.5), 
  Rationale = c("once per week", "once per two weeks", "once per 3 months", "once per 4 months", "once per week", "once per 2 weeks")
)

resource_usage <- data.frame(
  Surgery = c('Surgery 1', 'Surgery 1', 'Surgery 1', 'Surgery 1', 'Surgery 4', 'Surgery 4', 'Surgery 4', 'Surgery 4', 'Surgery 6', 'Surgery 6', 'Surgery 6', 'Surgery 6'),
  Complexity = c('Complexity 1', 'Complexity 1', 'Complexity 2', 'Complexity 2', 'Complexity 1', 'Complexity 1', 'Complexity 2', 'Complexity 2', 'Complexity 1', 'Complexity 1', 'Complexity 2', 'Complexity 2'),
  Resource_Type = c('Admissions', 'OR_Time','Admissions', 'OR_Time','Admissions', 'OR_Time','Admissions', 'OR_Time','Admissions', 'OR_Time','Admissions', 'OR_Time'), 
  Usage = c(0, 3, 1,4,1,4,1,5.5,0,1.5,0,2.5)
)

resource_capacity <- data.frame(
  Resouce = c('Admissions', 'OR_Time'),
  Capacity_Weekly = c(1.5, 11.25),
  Unit = c("Patients Admitted per week", "OR Hours per week")
)


temp1 <- read_csv("Report_Stuff/R2_basic.csv") %>% mutate(type = 'basic')
temp2 <- read_csv("Report_Stuff/R2_prio.csv") %>% mutate(type = 'prio')
R1R2_beta_data <- bind_rows(temp1, temp2)

temp1 <- read_csv("Report_Stuff/R2_basic_myopic.csv") %>% mutate(type = 'basic')
temp2 <- read_csv("Report_Stuff/R2_prio_myopic.csv") %>% mutate(type = 'prio')
R1R2_beta_data_myopic <- bind_rows(temp1, temp2)

### Generate Plots
R1R2_policy <- (ggplot(R1R2_beta_data %>% filter(M == 0), aes(x=T, y=Val, color=C, shape=D, linetype=D)) +
    geom_line() + geom_point() +
    facet_wrap(. ~ type, scales='free') +
    scale_x_continuous(breaks=seq(0,10), limits = c(1,10))) %>% ggplotly()
R1R2_policy_myopic <- (ggplot(R1R2_beta_data_myopic %>% filter(M == 0), aes(x=T, y=Val, color=C, shape=D, linetype=D)) +
    geom_line() + geom_point() +
    facet_wrap(. ~ type, scales='free') +
    scale_x_continuous(breaks=seq(0,10), limits = c(1,10))) %>% ggplotly()
```

# Parameters 

## Model Parameters
This model is a smaller instance of the full problem:

* Planning horizon is decreased from 24 weeks to 10 weeks
* Maximum tracked wait is decreased from 6 weeks to 4 weeks
* There are 3 surgeries instead of 6 surgeries
* Number of priorities is set to 1

## Simulation Parameters
* 30 Replications
* 1250 weeks duration
* 250 weeks warm up

## Surgeries
1) **Surgery 1** - 1. SPINE POSTERIOR DECOMPRESSION/LAMINECTOMY LUMBAR
2) **Surgery 4** - 4. SPINE POST CERV DECOMPRESSION AND FUSION W INSTR
3) **Surgery 6** - 6. SPINE POSTERIOR DISCECTOMY LUMBAR

## Arrival Rate
It was set to be 95% of the capacity, however due to transitions, the resource usage should be higher than 95% 
  
``` {r echo=FALSE, cache=FALSE}
kable(arrival_rate)
```

## Resource Usage

Usage of the resources
```{r echo=FALSE, cache=FALSE}
kable(resource_usage)
```

## Resource Capacity
```{r echo=FALSE, cache=FALSE}
kable(resource_capacity)
```

# R1R2 Report
This model is the default model that does not penalize bed under utilization

## Policy Description

The description will be based on the following graphs (both of them are for M of 0 only):

```{r echo=FALSE, cache=FALSE}
R1R2_policy
```
```{r echo=FALSE, xcache=FALSE}
R1R2_policy_myopic
```

The graph on the left shows in which days the MDP policy will allow scheduling. If the value is below 0 - the model will allow scheduling, otherwise the model will keep patients in the waitlist. Thus this policy **will only schedule into week 1 and week 2**

The plot on the right shows the approximate priority of different surgeries. The lower the surgery is on the list the more likely it is to be scheduled first.    

## Policy Results


# R1R2R3 Report
In addition to the parameters above, this model penalizes bed under utilization in the first period

## Policy Description

The description will be based on the following graphs:

```{r echo=FALSE, cache=FALSE}
R1R2_policy
```

## Policy Results


The policy description is based on the following graphs.



